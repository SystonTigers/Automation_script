name: Deploy to Google Apps Script

on:
  push:
    branches: [ main, master ]
    paths:
      - 'src/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install clasp
      run: npm install -g @google/clasp

    - name: Verify required secrets
      run: |
        if [[ -z "${{ secrets.ACCESS_TOKEN }}" ]] || [[ -z "${{ secrets.REFRESH_TOKEN }}" ]] || [[ -z "${{ secrets.CLIENT_ID }}" ]] || [[ -z "${{ secrets.CLIENT_SECRET }}" ]] || [[ -z "${{ secrets.SCRIPT_ID }}" ]]; then
          echo "âŒ Missing required secrets. Please check README-OAUTH-SETUP.md for setup instructions."
          echo "Required secrets: ACCESS_TOKEN, REFRESH_TOKEN, CLIENT_ID, CLIENT_SECRET, SCRIPT_ID"
          exit 1
        else
          echo "âœ… All required secrets are configured"
        fi

    - name: Create .clasprc.json for authentication
      run: |
        echo "ðŸ”‘ Creating authentication file..."
        cat > ~/.clasprc.json << EOF
        {
          "tokens": {
            "default": {
              "client_id": "${{ secrets.CLIENT_ID }}",
              "client_secret": "${{ secrets.CLIENT_SECRET }}",
              "type": "authorized_user",
              "refresh_token": "${{ secrets.REFRESH_TOKEN }}",
              "access_token": "${{ secrets.ACCESS_TOKEN }}"
            }
          }
        }
        EOF
        echo "âœ… Authentication file created"

    - name: Verify authentication file
      run: |
        echo "ðŸ“‹ Checking authentication setup..."
        ls -la ~/.clasprc.json
        echo "ðŸ“„ File contents (without secrets):"
        cat ~/.clasprc.json | jq 'del(.tokens.default.client_secret, .tokens.default.access_token, .tokens.default.refresh_token)'

    - name: Create .clasp.json with Script ID
      run: |
        echo "ðŸ“ Creating project configuration..."
        cat > .clasp.json << EOF
        {
          "scriptId": "${{ secrets.SCRIPT_ID }}",
          "rootDir": "./src",
          "fileExtension": "gs"
        }
        EOF
        echo "âœ… Project configuration created"
        cat .clasp.json

    - name: Test clasp login status
      run: |
        echo "ðŸ” Testing clasp authentication..."
        clasp login --status || echo "Login status check failed - continuing with push"

    - name: Push to Google Apps Script
      run: |
        echo "ðŸš€ Deploying to Apps Script..."
        clasp push --force
        echo "âœ… Push completed successfully"

    - name: Create deployment (main branch only)
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        echo "ðŸ“¦ Creating deployment..."
        clasp deploy --description "Automated deployment from GitHub Actions - $(date '+%Y-%m-%d %H:%M:%S')"
        echo "âœ… Deployment created successfully"

    - name: Deployment success notification
      if: success()
      run: |
        echo "ðŸŽ‰ Successfully deployed to Google Apps Script!"
        echo "ðŸ“ Changes in src/ folder have been pushed to Apps Script project"
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "ðŸ“¦ A new deployment was also created"
        fi

    - name: Deployment failure notification
      if: failure()
      run: |
        echo "âŒ Deployment failed!"
        echo "ðŸ” Check the logs above for details"
        echo "ðŸ“– Refer to TROUBLESHOOTING.md for common solutions"
        echo "ðŸ  Authentication file location: ~/.clasprc.json"
        echo "ðŸ“ Project file location: .clasp.json"