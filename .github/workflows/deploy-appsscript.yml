name: Deploy to Google Apps Script

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install clasp
      run: npm install -g @google/clasp

    - name: Create .clasprc.json
      run: |
        echo '{
          "token": {
            "access_token": "${{ secrets.ACCESS_TOKEN }}",
            "refresh_token": "${{ secrets.REFRESH_TOKEN }}",
            "scope": "https://www.googleapis.com/auth/script.projects",
            "token_type": "Bearer",
            "expiry_date": 9999999999999
          },
          "oauth2ClientSettings": {
            "clientId": "${{ secrets.CLIENT_ID }}",
            "clientSecret": "${{ secrets.CLIENT_SECRET }}",
            "redirectUri": "http://localhost"
          },
          "isLocalCreds": false
        }' > ~/.clasprc.json

    - name: Create .clasp.json
      run: |
        echo '{
          "scriptId": "${{ secrets.SCRIPT_ID }}",
          "rootDir": "./src"
        }' > .clasp.json

    - name: Push to Apps Script
      run: |
        echo "ğŸš€ Deploying to Google Apps Script..."
        clasp push --force
        echo "âœ… Successfully deployed to Apps Script"

    - name: Verify Deployment
      run: |
        echo "ğŸ” Verifying deployment..."
        clasp version
        echo "âœ… Deployment verified"