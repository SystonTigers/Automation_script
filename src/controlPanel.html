<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Syston Tigers – Control Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root { --bg:#0b0b0b; --card:#151515; --accent:#ffd200; --muted:#999; --ok:#29a745; --warn:#e0a800; --err:#dc3545; }
    html,body { background:#0b0b0b; color:#f6f6f6; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif; margin:0; }
    .wrap { max-width:1100px; margin:32px auto; padding:0 16px; }
    h1 { margin:0 0 20px; font-size:26px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); gap:16px; }
    .card { background:var(--card); border:1px solid #222; border-radius:16px; padding:16px; box-shadow:0 1px 10px rgba(0,0,0,.25); }
    .card h2 { margin:0 0 12px; font-size:18px; color:#fff; }
    .muted { color:var(--muted); font-size:12px; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:8px 0; border-top:1px solid #1f1f1f; }
    .row:first-child { border-top:none; padding-top:0; }
    .btn { display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:10px; border:1px solid #2a2a2a; background:#111; color:#fff; cursor:pointer; }
    .btn:hover { background:#171717; }
    .btn.primary { background:var(--accent); color:#000; border-color:#e6be00; font-weight:700; }
    .btn.ghost { background:transparent; }
    .btn-row { display:flex; gap:10px; flex-wrap:wrap; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid #2a2a2a; font-size:12px; }
    .ok { border-color:#215c33; background:rgba(41,167,69,.1); color:#b6ffca; }
    .warn { border-color:#5c4a21; background:rgba(224,168,0,.12); color:#ffe8a6; }
    .err { border-color:#5c2121; background:rgba(220,53,69,.12); color:#ffc2c7; }
    .switch { position:relative; width:48px; height:28px; }
    .switch input { display:none; }
    .slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background:#333; transition:.2s; border-radius:14px; }
    .slider:before { position:absolute; content:''; height:22px; width:22px; left:3px; top:3px; background:#999; transition:.2s; border-radius:50%; }
    input:checked + .slider { background:var(--accent); }
    input:checked + .slider:before { transform:translateX(20px); background:#000; }
    .kv { display:grid; grid-template-columns: 140px 1fr; gap:8px; font-size:14px; }
    .kv div { padding:4px 0; border-bottom:1px dashed #262626; }
    .kv div:nth-child(odd) { color:#ccc; }
    small.code { display:inline-block; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#0f0f0f; border:1px solid #222; border-radius:6px; padding:2px 6px; color:#ddd; }
    .privacy-list { list-style:none; margin:8px 0 0 0; padding:0; }
    .privacy-list li { padding:6px 0; border-bottom:1px solid #1f1f1f; font-size:13px; }
    .privacy-list li:last-child { border-bottom:none; }
    .privacy-block { margin-top:12px; }
    .toggle-stack { display:flex; flex-direction:column; gap:10px; width:100%; }
    .toggle-item small { color:#6b7280; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>⚙️ Syston Tigers – Control Panel</h1>

    <div class="grid">
      <div class="card">
        <h2>System status</h2>
        <div id="statusPills" class="btn-row" style="margin-bottom:10px;"></div>
        <div class="kv" id="sysInfo"></div>
        <div class="row" style="margin-top:12px;">
          <div class="muted">Validate configuration & connections</div>
          <button class="btn" onclick="refreshValidation()">Re-validate</button>
        </div>
      </div>

      <div class="card">
        <h2>Feature toggles</h2>
        <div id="featureList"></div>
        <div class="row">
          <div class="muted">Toggle & Save</div>
          <div class="btn-row">
            <button class="btn primary" onclick="saveFeatures()">Save changes</button>
            <button class="btn ghost" onclick="loadState()">Reset</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Privacy & Consent</h2>
        <div id="privacySummary" class="kv"></div>
        <div id="privacyExpiry" class="privacy-block"></div>
        <div class="row">
          <div class="muted">Safeguards</div>
          <div id="privacyToggles" class="toggle-stack"></div>
        </div>
      </div>

      <div class="card">
        <h2>Run now</h2>
        <div class="btn-row">
          <button class="btn" onclick="runAction('runBatchFixtures')">Run: Batch (fixtures+results+postponed)</button>
          <button class="btn" onclick="runAction('runFixturesBatch')">Run: Fixtures batch</button>
          <button class="btn" onclick="runAction('runResultsBatch')">Run: Results batch</button>
          <button class="btn" onclick="runAction('runPostponedBatch')">Run: Postponed</button>
          <button class="btn" onclick="runAction('runWeeklySchedulerNow')">Run: Weekly scheduler (today)</button>
        </div>
      </div>

      <div class="card">
        <h2>Notes</h2>
        <div class="muted">
          • Uses <small class="code">validateConfiguration()</small> from <small class="code">config.js</small> for health. <br>
          • Make.com router keys must exist (e.g. <small class="code">fixtures_1_league … fixtures_5_league</small>,
          <small class="code">results_1_league … results_5_league</small>, <small class="code">match_postponed</small>).<br>
          • Script Properties must set <small class="code">SPREADSHEET_ID</small> and <small class="code">MAKE_WEBHOOK_URL</small>.
        </div>
      </div>
    </div>
  </div>

  <script>
    const el = s => document.querySelector(s);
    const pills = (arr) => arr.map(x => `<span class="pill ${x.cls}">${x.text}</span>`).join('');

    function loadState() {
      google.script.run.withSuccessHandler(state => {
        const { features, info, validation, privacy, privacyFlags } = state;
        // info
        el('#sysInfo').innerHTML = `
          <div>Version</div><div>${info.version}</div>
          <div>Club</div><div>${info.club}</div>
          <div>Season</div><div>${info.season}</div>
          <div>Timezone</div><div>${info.tz}</div>
          <div>Webhook</div><div>${info.webhook ? 'Configured' : 'Missing'}</div>
        `;

        // validation pills
        const p = [];
        if (validation.valid) p.push({cls:'ok', text:'Config OK'});
        else p.push({cls:'err', text:'Config Issues'});
        if (validation.warnings?.length) p.push({cls:'warn', text:`${validation.warnings.length} warning(s)`});
        el('#statusPills').innerHTML = pills(p);

        // features
        const html = Object.keys(features).sort().map(k => {
          const checked = features[k] ? 'checked' : '';
          return `
            <div class="row">
              <div style="display:flex;align-items:center; gap:10px;">
                <label class="switch">
                  <input type="checkbox" data-key="${k}" ${checked}>
                  <span class="slider"></span>
                </label>
                <div><b>${k}</b></div>
              </div>
            </div>
          `;
        }).join('');
        el('#featureList').innerHTML = html;

        // privacy summary
        const summary = (privacy && privacy.success !== false) ? (privacy.summary || {}) : {};
        if (Object.keys(summary).length > 0) {
          el('#privacySummary').innerHTML = `
            <div>Total players</div><div>${summary.total_players ?? 0}</div>
            <div>Minors</div><div>${summary.minors ?? 0}</div>
            <div>Minors needing consent</div><div>${summary.minors_without_active_consent ?? 0}</div>
            <div>Blocked (7d)</div><div>${summary.audit?.blocked_last_7_days ?? 0}</div>
          `;

          const expiring = summary.expiring_consents || [];
          if (expiring.length) {
            const list = expiring.slice(0, 5).map(item => `
              <li><strong>${item.playerName}</strong> · ${item.consentType} · ${item.days_remaining} day(s)</li>
            `).join('');
            el('#privacyExpiry').innerHTML = `<div class="muted">Expiring soon</div><ul class="privacy-list">${list}</ul>`;
          } else {
            el('#privacyExpiry').innerHTML = '<div class="muted">No consents expiring in the next window.</div>';
          }
        } else {
          el('#privacySummary').innerHTML = '<div class="muted">Privacy summary unavailable.</div>';
          el('#privacyExpiry').innerHTML = '';
        }

        const pFlags = privacyFlags || {};
        el('#privacyToggles').innerHTML = `
          <div class="toggle-item">
            <label class="switch">
              <input type="checkbox" data-privacy="anonymiseFaces" ${pFlags.anonymiseFaces ? 'checked' : ''}>
              <span class="slider"></span>
            </label>
            <div class="label">Force anonymised faces when uncertain<br><small>Applies to all outbound media</small></div>
          </div>
          <div class="toggle-item">
            <label class="switch">
              <input type="checkbox" data-privacy="useInitialsOnly" ${pFlags.useInitialsOnly ? 'checked' : ''}>
              <span class="slider"></span>
            </label>
            <div class="label">Use initials for minors or sensitive posts<br><small>Overrides player names automatically</small></div>
          </div>
        `;

      }).getControlPanelState();
    }

    function saveFeatures() {
      const featureInputs = [...document.querySelectorAll('input[data-key]')];
      const features = {};
      featureInputs.forEach(i => features[i.dataset.key] = i.checked);

      const privacyInputs = [...document.querySelectorAll('input[data-privacy]')];
      const privacyFlags = {};
      privacyInputs.forEach(i => privacyFlags[i.dataset.privacy] = i.checked);

      google.script.run.withSuccessHandler(loadState).updateControlPanelSettings({
        features,
        privacyFlags
      });
    }

    function refreshValidation() {
      google.script.run.withSuccessHandler(v => {
        const p = [];
        if (v.valid) p.push({cls:'ok', text:'Config OK'});
        else p.push({cls:'err', text:'Config Issues'});
        if (v.warnings?.length) p.push({cls:'warn', text:`${v.warnings.length} warning(s)`});
        el('#statusPills').innerHTML = pills(p);
        alert((v.valid ? 'Validation OK' : 'Issues found') + (v.issues?.length ? `\n• ${v.issues.join('\n• ')}` : ''));
      }).getValidation();
    }

    function runAction(name) {
      google.script.run.withSuccessHandler(r => {
        alert(r && r.message ? r.message : 'Triggered: ' + name);
      }).actionRunRunner(name);
    }

    document.addEventListener('DOMContentLoaded', loadState);
  </script>
</body>
</html>
